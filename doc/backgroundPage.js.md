## About `backgroundPage.js`

This file is a background page, which runs code asynchronously in the background at installation and during startup. After installation, the add-on queries for a configuration file URL, and checks to see if installed extensions are whitelisted. On startup, it checks if the currently enabled extensions are not on the whitelist, and alerts the user if they aren't. 

#### Detailed Description (for developers)

This script file contains two global variables, which are declared near the top of the file:

```javascript
var configUrl = null;
var passAudit = null;
```

On installation, the script prompts the user for a configuration URL (the example configuration is the default value for the prompt). 

_Prompting the user for a configuration URL._  
![Prompting the user for a configuration URL](https://raw.githubusercontent.com/LightSys/chrome-audit-addon/master/doc/backgroundPage.js_img/backgroundPage.js_img00.png)

The file, which is formatted as JSON, downloaded with JQuery, and parsed. To learn more about the configuration file, see the following documentation files:  
[The example configuration script](files/testconfig.json.md)  
[How to write a custom configuration script](writing_config.md)

On installation, each time Chrome is started, and when an extension is enabled or disabled, this script runs `checkConfigFile()`. This gets the current whitelist of extensions from the `configUrl` variable (which is set at installation, stored persistently, and can be modified from the options page), and compares it to the list of enabled extensions (generated by `getInstalledExtensions()`) using the `compareExtensions()` function. 

This requires the `chrome.management` API to run, sets the `passAudit` variable, and alerts the user of there are any non-approved extensions enabled. 

_Alerting the user of non-approved extensions_  
![Alerting the user of non-approved extensions](https://raw.githubusercontent.com/LightSys/chrome-audit-addon/master/doc/backgroundPage.js_img/backgroundPage.js_img01.png)

[View the source code for this file](../backgroundPage.js).

Functions and methods used
------------------------------------
checkConfigFile(configUrl, suppressAlert): This function pulls the configuration file from the user defined URL and calls getInstalledExtensions. This function then calls compareExtensions.

getInstalledExtensions(done): This function retrieves an array of installed and enabled add-ons and calls back to checkConfigFile with the array.

compareExtensions(whitelistIds, installedExtensions, done): This function compares the list of installed add-ons against the supplied white-list from the configuration file and assembles an array of bad add-ons. The function is passed a callback function which takes the array of bad add-ons and fails the audit if the bad add-ons array contains any values.

auditPassed(suppressAlert): Assigns "True" to the passAudit variable, logs a success message to the console, and sets the bad add-ons array to null.

auditFailed(badAddons, suppressAlert): Assigns "False" to the passAudit variable, logs an alert with failure message and list of bad add-ons to the console, and calls set_badAddons.



createHmac_And_Assemble(key, salt, message, done): This function takes in the concatenates the salt and message as mentioned in the requirements then creates the HMAC using the key which is then returned as a callback function.

getConfigUrl(function()): This is where I had most of the coding take place after getting the configuration file.

show_pass_fail(): This function returns the current message from the add-on.

Encrytion: All encryption was done using the cryptojs file.

[Return to the README.md file](../README.md)
